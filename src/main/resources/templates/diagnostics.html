<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::body/content}, 'MailAI Diagnostics', ~{::head/extraHead})}">
<head>
    <th:block th:fragment="extraHead">
        <style>
            .team-info {
                background: rgba(255,255,255,0.1);
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
            }

            .team-info h3 {
                margin: 0 0 15px 0;
                font-size: 1.3em;
            }

            .team-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }

            .team-item {
                background: rgba(255,255,255,0.1);
                padding: 10px 15px;
                border-radius: 5px;
            }

            .team-item strong {
                display: block;
                margin-bottom: 5px;
            }

            .main-content {
                padding: 30px;
            }

            .section {
                margin-bottom: 40px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
            }

            .section-header {
                background: #f8f9fa;
                padding: 20px;
                border-bottom: 1px solid #e0e0e0;
            }

            .section-header h2 {
                margin: 0;
                color: #495057;
                font-size: 1.5em;
            }

            .section-content {
                padding: 20px;
            }

            .input-group input {
                box-sizing: border-box;
            }

            .json-display {
                margin: 10px 0;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <div class="header">
                <h1>AI for Email Diagnostics</h1>
                <div class="team-info">
                    <h3>Project Information</h3>
                    <div class="team-grid">
                        <div class="team-item">
                            <strong>Project Title:</strong>
                            AI for Email
                        </div>
                        <div class="team-item">
                            <strong>Team Name:</strong>
                            MailAI
                        </div>
                        <div class="team-item">
                            <strong>Team Lead:</strong>
                            William Callahan
                        </div>
                    </div>
                    <div class="team-grid">
                        <div class="team-item">
                            <strong>Team Members:</strong>
                            William Callahan, Mihir Gupta, Ashish Divakaran
                        </div>
                        <div class="team-item">
                            <strong>GitHub Usernames:</strong>
                            ashgithubmaker, Readermihir, WilliamAGH
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <!-- System Health Section -->
                <div class="section">
                    <div class="section-header">
                        <h2>System Health</h2>
                    </div>
                    <div class="section-content">
                        <button id="healthCheckBtn" class="button">Check Health</button>
                        <div id="healthStatus"></div>
                        <div id="healthResults"></div>
                    </div>
                </div>

                <!-- Run Sample Query Section -->
                <div class="section">
                    <div class="section-header">
                        <h2>Run Sample Query</h2>
                    </div>
                    <div class="section-content">
                        <div class="input-group">
                            <label for="queryInput">Enter your query:</label>
                            <input type="text" id="queryInput" placeholder="e.g., How do I schedule a meeting with my team?" />
                        </div>
                        <button id="runQueryBtn" class="button">Run Query</button>
                        <div id="queryResults"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Mock data for when endpoints are not available
            const MOCK_HEALTH_RESPONSE = {
                status: "healthy",
                timestamp: new Date().toISOString(),
                services: {
                    database: "connected",
                    search_engine: "online",
                    llm_service: "available"
                },
                version: "1.0.0"
            };

            const MOCK_SEARCH_RESPONSE = {
                query: "",
                intent: "email_assistance",
                context_summary: "User is asking for help with email management and productivity features",
                documents: [
                    {
                        id: "doc_001",
                        title: "Email Management Best Practices",
                        content: "Guidelines for organizing and managing email effectively...",
                        score: 0.95,
                        source: "knowledge_base"
                    },
                    {
                        id: "doc_002", 
                        title: "Meeting Scheduling Features",
                        content: "How to use calendar integration for meeting scheduling...",
                        score: 0.87,
                        source: "user_manual"
                    },
                    {
                        id: "doc_003",
                        title: "Team Collaboration Tools",
                        content: "Available tools for team communication and collaboration...",
                        score: 0.76,
                        source: "feature_docs"
                    }
                ],
                processing_time_ms: 145
            };

            const MOCK_GENERATE_RESPONSE = {
                query: "",
                answer: "Based on your query about scheduling meetings, I can help you set up team meetings efficiently. You can use the integrated calendar feature to check team availability, send meeting invites, and set up automated reminders. The system also supports recurring meetings and can suggest optimal meeting times based on team preferences.",
                sources_used: ["doc_001", "doc_002"],
                confidence: 0.92,
                processing_time_ms: 890
            };

            // Utility functions
            function createCollapsible(title, content, isOpen = false) {
                const collapsible = document.createElement('div');
                collapsible.className = 'collapsible';
                
                const header = document.createElement('div');
                header.className = 'collapsible-header';
                header.innerHTML = `
                    <span>${title}</span>
                    <span>${isOpen ? '▼' : '▶'}</span>
                `;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `collapsible-content ${isOpen ? 'open' : ''}`;
                contentDiv.innerHTML = content;
                
                header.addEventListener('click', () => {
                    contentDiv.classList.toggle('open');
                    const arrow = header.querySelector('span:last-child');
                    arrow.textContent = contentDiv.classList.contains('open') ? '▼' : '▶';
                });
                
                collapsible.appendChild(header);
                collapsible.appendChild(contentDiv);
                
                return collapsible;
            }

            function formatJSON(obj) {
                return JSON.stringify(obj, null, 2);
            }

            function showLoading(element) {
                element.innerHTML = '<div class="loading-spinner"></div>Processing...';
            }

            function showError(element, message) {
                element.innerHTML = `<div class="error-message">Error: ${message}</div>`;
            }

            // Health check functionality
            document.getElementById('healthCheckBtn').addEventListener('click', async () => {
                const btn = document.getElementById('healthCheckBtn');
                const status = document.getElementById('healthStatus');
                const results = document.getElementById('healthResults');
                
                btn.disabled = true;
                showLoading(status);
                results.innerHTML = '';
                
                try {
                    let response;
                    let data;
                    
                    try {
                        response = await fetch('/api/health');
                        data = await response.json();
                    } catch (error) {
                        console.log('API not available, using mock data');
                        data = MOCK_HEALTH_RESPONSE;
                        response = { ok: true };
                    }
                    
                    const isHealthy = response.ok && (data.status === 'healthy' || data.status === 'ok');
                    const statusClass = isHealthy ? 'pass' : 'fail';
                    const statusText = isHealthy ? 'PASS' : 'FAIL';
                    
                    status.innerHTML = `Health Check: <span class="status ${statusClass}">${statusText}</span>`;
                    
                    const jsonDisplay = `<div class="json-display">${formatJSON(data)}</div>`;
                    const collapsible = createCollapsible('Health Check Response', jsonDisplay, true);
                    results.appendChild(collapsible);
                    
                } catch (error) {
                    showError(status, error.message);
                } finally {
                    btn.disabled = false;
                }
            });

            // Query execution functionality
            document.getElementById('runQueryBtn').addEventListener('click', async () => {
                const btn = document.getElementById('runQueryBtn');
                const queryInput = document.getElementById('queryInput');
                const results = document.getElementById('queryResults');
                const query = queryInput.value.trim();
                
                if (!query) {
                    showError(results, 'Please enter a query');
                    return;
                }
                
                btn.disabled = true;
                showLoading(results);
                
                try {
                    // Step 1: Display initial query
                    results.innerHTML = `
                        <div class="pipeline-step">
                            <h4>1. Initial Query</h4>
                            <div class="json-display">${query}</div>
                        </div>
                    `;
                    
                    // Step 2: Search API call
                    let searchData;
                    try {
                        const searchResponse = await fetch('/api/search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query })
                        });
                        searchData = await searchResponse.json();
                    } catch (error) {
                        console.log('Search API not available, using mock data');
                        searchData = { ...MOCK_SEARCH_RESPONSE, query };
                    }
                    
                    // Display search results
                    const searchStep = document.createElement('div');
                    searchStep.className = 'pipeline-step';
                    searchStep.innerHTML = `
                        <h4>2. Intent/Context Summary</h4>
                        <p><strong>Intent:</strong> ${searchData.intent || 'N/A'}</p>
                        <p><strong>Context:</strong> ${searchData.context_summary || 'N/A'}</p>
                    `;
                    results.appendChild(searchStep);
                    
                    // Display RAG retrieval results
                    const ragStep = document.createElement('div');
                    ragStep.className = 'pipeline-step';
                    ragStep.innerHTML = '<h4>3. RAG Retrieval Results</h4>';
                    
                    if (searchData.documents && searchData.documents.length > 0) {
                        const documentsContainer = document.createElement('div');
                        searchData.documents.forEach((doc, index) => {
                            const docElement = document.createElement('div');
                            docElement.className = 'document-item';
                            docElement.innerHTML = `
                                <div class="document-score">${(doc.score * 100).toFixed(1)}%</div>
                                <strong>${doc.title || `Document ${index + 1}`}</strong>
                                <p>${doc.content ? doc.content.substring(0, 150) + '...' : 'No content preview'}</p>
                                <small>Source: ${doc.source || 'Unknown'}</small>
                            `;
                            documentsContainer.appendChild(docElement);
                        });
                        
                        const ragCollapsible = createCollapsible('Retrieved Documents', documentsContainer.innerHTML, true);
                        ragStep.appendChild(ragCollapsible);
                    } else {
                        ragStep.innerHTML += '<p>No documents retrieved</p>';
                    }
                    
                    const searchJsonCollapsible = createCollapsible('Full Search Response', 
                        `<div class="json-display">${formatJSON(searchData)}</div>`);
                    ragStep.appendChild(searchJsonCollapsible);
                    results.appendChild(ragStep);
                    
                    // Step 4: Generate API call
                    let generateData;
                    try {
                        const generateResponse = await fetch('/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                query,
                                context: searchData.documents || []
                            })
                        });
                        generateData = await generateResponse.json();
                    } catch (error) {
                        console.log('Generate API not available, using mock data');
                        generateData = { ...MOCK_GENERATE_RESPONSE, query };
                    }
                    
                    // Display final answer
                    const generateStep = document.createElement('div');
                    generateStep.className = 'pipeline-step';
                    generateStep.innerHTML = `
                        <h4>4. Final LLM Answer</h4>
                        <div style="background: white; padding: 15px; border-radius: 4px; margin: 10px 0;">
                            ${generateData.answer || 'No answer generated'}
                        </div>
                        <p><strong>Confidence:</strong> ${generateData.confidence ? (generateData.confidence * 100).toFixed(1) + '%' : 'N/A'}</p>
                        <p><strong>Sources Used:</strong> ${generateData.sources_used ? generateData.sources_used.join(', ') : 'None'}</p>
                    `;
                    
                    const generateJsonCollapsible = createCollapsible('Full Generate Response',
                        `<div class="json-display">${formatJSON(generateData)}</div>`);
                    generateStep.appendChild(generateJsonCollapsible);
                    results.appendChild(generateStep);
                    
                } catch (error) {
                    showError(results, error.message);
                } finally {
                    btn.disabled = false;
                }
            });

            // Allow Enter key to trigger query
            document.getElementById('queryInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('runQueryBtn').click();
                }
            });
        </script>
    </div>
</body>
</html>