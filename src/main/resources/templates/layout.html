<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content, pageTitle, headContent)">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Composer" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ["-apple-system", "BlinkMacSystemFont", "'Segoe UI'", "system-ui", "sans-serif"],
                    },
                    colors: {
                        brand: {
                            DEFAULT: "#0f172a",
                            surface: "#f8fafc",
                            muted: "#e2e8f0",
                        },
                    },
                    boxShadow: {
                        ultra: "0 25px 50px -12px rgba(15, 23, 42, 0.25)",
                    },
                    backgroundImage: {
                        "subtle-glow": "linear-gradient(180deg, rgba(15, 23, 42, 0.08) 0%, rgba(15, 23, 42, 0) 60%)",
                    },
                },
            },
        };
    </script>
    <link rel="stylesheet" href="/css/layout.css" />
    <title th:text="${pageTitle}">Composer</title>
    <th:block th:if="${headContent} != null" th:replace="${headContent}"></th:block>
</head>
<body>
    <!-- Load critical dependencies FIRST before any page content -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" integrity="sha256-8zoteDYr3gAWcOOimwH9DcFqf5GU0EKnda+JJwqzi3Q=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" integrity="sha256-0kaYYq3qitkkVZpP/6uKTJwfTpqFNM6OHDbsaYzw9Uw=" crossorigin="anonymous"></script>
    <script>
        // Minimal shared utilities available to all pages
        window.Composer = window.Composer || {};
        
        /**
         * Safely render markdown to HTML with XSS protection
         * Uses marked.js for parsing and DOMPurify for sanitization
         */
        window.Composer.renderMarkdown = function(markdown) {
            if (!markdown || typeof markdown !== 'string') return '';
            try {
                // Preserve single newlines as <br> and enable GFM for lists/tables
                const rawHtml = marked.parse(markdown, { breaks: true, gfm: true });
                return DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                                   'ul', 'ol', 'li', 'a', 'code', 'pre', 'blockquote', 'table', 'thead', 
                                   'tbody', 'tr', 'th', 'td', 'hr', 'div', 'span', 'img'],
                    ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'class', 'src', 'alt', 'width', 'height',
                                   'loading', 'decoding', 'style', 'srcset', 'sizes'],
                    ALLOW_DATA_ATTR: false
                });
            } catch (e) {
                console.error('Markdown rendering error:', e);
                return DOMPurify.sanitize(markdown);
            }
        };
        
        /**
         * Safely escape HTML for plain text display
         */
        window.Composer.escapeHtml = function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        /**
         * Format file size in human-readable format
         */
        window.Composer.formatFileSize = function(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };
        
        /**
         * DRY: central email parsing used by chat and backend tools
         * Requires UI_NONCE to be set globally before calling (typically from page template)
         */
        window.Composer.parseEmailFile = async function(file, uiNonce) {
            const formData = new FormData();
            formData.append('file', file);
            const headers = {};
            
            // Add X-UI-Request nonce if provided (required by ApiUiNonceGuardFilter)
            if (uiNonce) {
                headers['X-UI-Request'] = uiNonce;
            }
            
            const response = await fetch('/api/qa/parse-email', {
                method: 'POST',
                headers: headers,
                body: formData
            });
            if (!response.ok) {
                const errorText = await response.text().catch(() => 'Unknown error');
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
            }
            return await response.json();
        };
        
        /**
         * Shared file upload handler for drag-and-drop and click-to-upload
         * Usage: new window.Composer.FileUploadHandler(options)
         */
        window.Composer.FileUploadHandler = class {
            constructor(options) {
                this.dropArea = options.dropArea;
                this.fileInput = options.fileInput;
                this.onFileSelected = options.onFileSelected;
                this.validExtensions = options.validExtensions || ['.eml', '.msg', '.txt'];
                this.validMimeTypes = options.validMimeTypes || ['message/rfc822', 'text/plain', 'application/octet-stream'];
                
                this.init();
            }
            
            init() {
                /**
                 * IMPORTANT: Click-to-upload functionality is handled natively by the browser
                 * when a <label> element's `for` attribute is correctly associated with an
                 * <input type="file"> element's `id`.
                 *
                 * DO NOT add `e.preventDefault()`, `e.stopPropagation()`, or a manual
                 * `.click()` call in this event listener. Doing so will break the native
                 * browser behavior and prevent the file dialog from opening. This listener
                 * is intentionally left sparse to allow the default action to proceed.
                 */
                this.dropArea.addEventListener('click', (e) => {
                    // If the dropArea is a <label>, the browser handles activating the input.
                    // In this case, we must NOT interfere by calling preventDefault() or click().
                    // If the dropArea is a generic element like a <div>, we need to
                    // manually trigger the click on the hidden file input.
                    if (this.dropArea.tagName.toLowerCase() !== 'label') {
                        // Don't prevent default if the click target is the input itself
                        // This allows the native file dialog to open when clicking the transparent input
                        if (e.target !== this.fileInput) {
                            e.preventDefault();
                            this.fileInput.click();
                        }
                    }
                });
                
                // Keyboard accessibility
                this.dropArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.fileInput.click();
                    }
                });
                
                // Drag and drop
                this.dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.dropArea.classList.add('border-slate-500', 'bg-slate-200');
                });
                
                this.dropArea.addEventListener('dragleave', () => {
                    this.dropArea.classList.remove('border-slate-500', 'bg-slate-200');
                });
                
                this.dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dropArea.classList.remove('border-slate-500', 'bg-slate-200');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });
                
                // File input change
                this.fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });
            }
            
            handleFile(file) {
                if (!file) return;
                
                // Validate file extension
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (!this.validExtensions.includes(fileExtension)) {
                    throw new Error(`Invalid file type. Please upload one of: ${this.validExtensions.join(', ')}`);
                }
                
                // Call the provided callback
                if (this.onFileSelected) {
                    this.onFileSelected(file);
                }
            }
        };
    </script>
    
    <!-- Page content inserted here by Thymeleaf -->
    <th:block th:replace="${content}"></th:block>

</body>
</html>
