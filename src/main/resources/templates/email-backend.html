<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::body/content}, 'ComposerAI - Email Backend Parser', ~{::head/extraHead})}">
<head>
    <th:block th:fragment="extraHead"></th:block>
</head>
<body>
    <div th:fragment="content" class="min-h-screen bg-slate-100/80 py-12">
        <div class="mx-auto flex max-w-6xl flex-col gap-10 px-4 sm:px-6 lg:px-8">
            <header class="relative overflow-hidden rounded-3xl border border-slate-200 bg-white/90 p-8 shadow-ultra shadow-slate-900/10 backdrop-blur">
                <div class="absolute inset-0 bg-subtle-glow"></div>
                <div class="relative z-10 flex flex-col gap-4">
                    <h1 class="text-3xl font-semibold tracking-tight text-slate-900 sm:text-4xl">ComposerAI Email Parser</h1>
                    <p class="max-w-2xl text-base text-slate-600">Upload email archives, preview raw content, and run them through the backend parsing pipeline with a tailored experience inspired by the diagnostics workspace.</p>
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-slate-600">Parser</span>
                        <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-100 px-3 py-1 text-xs font-medium text-slate-700">Supports .eml, .msg, .txt</span>
                    </div>
                </div>
            </header>

            <main class="grid grid-cols-1 gap-8">
                <section class="rounded-3xl border border-slate-200 bg-white/90 shadow-lg shadow-slate-900/5">
                    <div class="flex flex-col gap-4 border-b border-slate-200 px-6 py-5">
                        <div>
                            <h2 class="text-lg font-semibold text-slate-900">Upload Email File</h2>
                            <p class="mt-1 text-sm text-slate-500">Drag & drop a supported email file or select one from your device.</p>
                        </div>
                    </div>
                    <div class="px-6 pb-6 pt-4">
                        <div>
                            <div id="fileInputWrapper" class="rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50/80 px-6 py-8 md:py-6 text-center transition hover:border-slate-300 hover:bg-slate-100/80">
                                <label for="fileInput" class="block">
                                    <div class="relative flex flex-col items-center justify-center gap-2">
                                        <input type="file" id="fileInput" accept=".eml,.msg,.txt,text/plain,message/rfc822" class="absolute inset-0 cursor-pointer opacity-0" />
                                        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-white text-xl shadow-sm">ðŸ“§</div>
                                        <div class="text-sm font-medium text-slate-700">
                                            Click to select or drag &amp; drop your `.eml` file
                                        </div>
                                        <p class="text-xs text-slate-500">Supported formats: .eml, .msg, .txt</p>
                                    </div>
                                </label>
                                <div class="mt-3">
                                    <button id="parseBtn" class="inline-flex items-center justify-center rounded-xl border border-slate-900/10 bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-900 disabled:cursor-not-allowed disabled:opacity-60" disabled>
                                        ðŸ”„ Parse Email
                                    </button>
                                </div>
                            </div>
                            <div id="fileInfo" class="mt-3 hidden rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-800"></div>
                        </div>

                        <div id="statusMessage" class="mt-4"></div>
                    </div>
                </section>

                <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
                    <section class="rounded-3xl border border-slate-200 bg-white/90 shadow-lg shadow-slate-900/5">
                        <div class="px-6 py-5">
                            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Raw Email Contents</h3>
                            <textarea id="rawContent" class="mt-3 h-[32rem] w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-3 text-sm font-medium text-slate-800 shadow-inner focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" placeholder="Raw email content will appear here after clicking 'Preview Raw Contents'..." readonly></textarea>
                        </div>
                    </section>
                    <section class="rounded-3xl border border-slate-200 bg-white/90 shadow-lg shadow-slate-900/5">
                        <div class="px-6 py-5">
                            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">Parsed Email Output</h3>
                            <textarea id="parsedContent" class="mt-3 h-[32rem] w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-3 text-sm font-medium text-slate-800 shadow-inner focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" placeholder="Parsed email content will appear here after clicking 'Send to Backend & Parse'..." readonly></textarea>
                        </div>
                    </section>
                </div>
                <div class="px-6 text-xs text-slate-500">
                    Tip: Parsed output uses backend extraction pipeline with HTML to text conversion and chunking strategy to deliver clean summaries.
                </div>
            </main>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                let selectedFile = null;

                // DOM elements
                const fileInput = document.getElementById('fileInput');
                const fileInputWrapper = document.getElementById('fileInputWrapper');
                const fileInfo = document.getElementById('fileInfo');
                const parseBtn = document.getElementById('parseBtn');
                const rawContent = document.getElementById('rawContent');
                const parsedContent = document.getElementById('parsedContent');
                const statusMessage = document.getElementById('statusMessage');

                // File input event listeners
                fileInput.addEventListener('change', handleFileSelect);
                fileInputWrapper.addEventListener('click', function (event) {
                    // Only trigger file input if clicking on the wrapper itself, not the file input
                    if (event.target !== fileInput) {
                        fileInput.click();
                    }
                });
                fileInputWrapper.addEventListener('dragover', handleDragOver);
                fileInputWrapper.addEventListener('dragleave', handleDragLeave);
                fileInputWrapper.addEventListener('drop', handleDrop);

                // Button event listeners
                parseBtn.addEventListener('click', sendToBackend);

                function handleFileSelect(event) {
                    const file = event.target.files[0];
                    processSelectedFile(file);
                }

                function handleDragOver(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.add('dragover');
                }

                function handleDragLeave(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.remove('dragover');
                }

                function handleDrop(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.remove('dragover');
                    const file = event.dataTransfer.files[0];

                    // Sync the file input with the dropped file
                    if (file) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;
                    }

                    processSelectedFile(file);
                }

                function processSelectedFile(file) {
                    if (!file) return;

                    // Validate file type by extension and MIME type
                    const validExtensions = ['.eml', '.msg', '.txt'];
                    const validMimeTypes = ['message/rfc822', 'text/plain', 'application/octet-stream'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                    const isValidExtension = validExtensions.includes(fileExtension);
                    const isValidMimeType = validMimeTypes.includes(file.type) || file.type === '';

                    if (!isValidExtension) {
                        showMessage('Please select a valid email file (.eml, .msg, or .txt)', 'error');
                        return;
                    }

                    selectedFile = file;

                    // Update file info display
                    fileInfo.classList.remove('hidden');
                    fileInfo.innerHTML = `
                        <strong>Selected file:</strong> ${file.name}<br>
                        <strong>Size:</strong> ${formatFileSize(file.size)}<br>
                        <strong>Type:</strong> ${file.type || 'Unknown'}
                    `;

                    // Enable buttons
                    parseBtn.disabled = false;

                    // Clear previous content
                    rawContent.value = '';
                    parsedContent.value = '';
                    statusMessage.innerHTML = '';

                    showMessage('File selected successfully! Preview generated from original file.', 'success');

                    previewRawContents();
                }

                function previewRawContents() {
                    if (!selectedFile) {
                        showMessage('Please select a file first.', 'error');
                        return;
                    }

                    const reader = new FileReader();

                    reader.onload = function (event) {
                        rawContent.value = event.target.result;
                        showMessage('Raw content loaded successfully!', 'success');
                    };

                    reader.onerror = function () {
                        showMessage('Error reading file. Please try again.', 'error');
                    };

                    reader.readAsText(selectedFile);
                }

                async function sendToBackend() {
                    if (!selectedFile) {
                        showMessage('Please select a file first.', 'error');
                        return;
                    }

                    parseBtn.innerHTML = '<span class="inline-flex items-center gap-2"><span class="h-3 w-3 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"></span>Parsing email...</span>';
                    parseBtn.disabled = true;
                    parsedContent.value = 'Processing...';

                    try {
                        const formData = new FormData();
                        formData.append('file', selectedFile);

                        const response = await fetch('/api/parse-email', {
                            method: 'POST',
                            mode: 'cors',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.status === 'success') {
                                parsedContent.value = result.parsedText;
                                parsedContent.dataset.markdown = result.parsedMarkdown || '';
                                showMessage('Email parsed successfully!', 'success');
                            } else {
                                throw new Error(result.error || 'Unknown error occurred');
                            }
                        } else {
                            const errorResult = await response.json().catch(() => ({ error: 'Unknown server error' }));
                            throw new Error(`Server error (${response.status}): ${errorResult.error}`);
                        }
                    } catch (error) {
                        parsedContent.value = `Error: ${error.message}`;
                        showMessage(`Failed to parse email: ${error.message}`, 'error');
                    } finally {
                        parseBtn.innerHTML = 'ðŸ”„ Parse Email';
                        parseBtn.disabled = false;
                    }
                }

                function showMessage(message, type) {
                    const base = 'rounded-xl px-4 py-3 text-sm font-medium';
                    const variant = type === 'error'
                        ? 'border border-rose-200 bg-rose-50 text-rose-700'
                        : 'border border-emerald-200 bg-emerald-50 text-emerald-700';
                    statusMessage.innerHTML = `<div class="${base} ${variant}">${message}</div>`;

                    // Auto-hide success messages after 5 seconds
                    if (type === 'success') {
                        setTimeout(() => {
                            if (statusMessage.innerHTML.includes(message)) {
                                clearMessage();
                            }
                        }, 5000);
                    }
                }

                function clearMessage() {
                    statusMessage.innerHTML = '';
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // Initialize
                showMessage('Ready to process email files. Select a .eml file to get started.', 'success');
            });
        </script>
    </div>
</body>
</html>