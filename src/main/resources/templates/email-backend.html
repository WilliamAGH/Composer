<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::body/content}, 'MailAI - Email Backend Parser', ~{::head/extraHead})}">
<head>
    <th:block th:fragment="extraHead">
        <style>
            .upload-section {
                border-radius: 12px;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                border: 1px solid #e1e8ed;
            }

            .upload-section h2 {
                margin-bottom: 20px;
                color: #2c3e50;
                font-size: 1.5em;
            }

            .file-input-container {
                margin-bottom: 20px;
            }

            .file-input-wrapper {
                position: relative;
                display: inline-block;
                cursor: pointer;
                background: #f8f9fa;
                border: 2px dashed #dee2e6;
                border-radius: 8px;
                padding: 40px;
                text-align: center;
                transition: all 0.3s ease;
                width: 100%;
            }

            .file-input-wrapper:hover {
                border-color: #667eea;
                background: #f0f4ff;
            }

            .file-input-wrapper.dragover {
                border-color: #667eea;
                background: #e3f2fd;
            }

            .file-input {
                position: absolute;
                opacity: 0;
                width: 100%;
                height: 100%;
                cursor: pointer;
            }

            .file-input-text {
                font-size: 1.1em;
                color: #6c757d;
            }

            .file-info {
                margin-top: 15px;
                padding: 10px;
                background: #e8f5e8;
                border-radius: 6px;
                color: #2d5a2d;
                display: none;
            }

            .buttons-container {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                background: #5a6fd8;
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover:not(:disabled) {
                background: #5a6268;
                transform: translateY(-1px);
            }

            .content-sections {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-top: 20px;
            }

            @media (max-width: 768px) {
                .content-sections {
                    grid-template-columns: 1fr;
                }

                .buttons-container {
                    flex-direction: column;
                }
            }

            .textarea {
                min-height: 400px;
                padding: 15px;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                font-size: 13px;
                line-height: 1.5;
                resize: vertical;
                background: #f8f9fa;
            }

            .textarea:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .status-info {
                margin-top: 10px;
                padding: 10px;
                background: #e3f2fd;
                border-radius: 6px;
                font-size: 14px;
                color: #1565c0;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <div class="header">
                <h1>MailAI Email Parser</h1>
                <p>Upload and parse .eml email files to extract readable content</p>
            </div>

            <div class="upload-section">
                <h2>üìß Upload Email File</h2>

                <div class="file-input-container">
                    <div class="file-input-wrapper" id="fileInputWrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".eml,.msg,.txt,text/plain,message/rfc822" />
                        <div class="file-input-text">
                            <strong>Click to select</strong> or <strong>drag & drop</strong> your .eml file here
                            <br><small>Supported formats: .eml, .msg, .txt</small>
                        </div>
                    </div>
                    <div id="fileInfo" class="file-info"></div>
                </div>

                <div class="buttons-container">
                    <button id="previewBtn" class="btn btn-secondary" disabled>
                        üìÑ Preview Raw Contents
                    </button>
                    <button id="parseBtn" class="btn btn-primary" disabled>
                        üîÑ Send to Backend & Parse
                    </button>
                </div>

                <div id="statusMessage"></div>
            </div>

            <div class="content-sections">
                <div class="section">
                    <h3>üìù Raw Email Contents</h3>
                    <textarea id="rawContent" class="textarea" placeholder="Raw email content will appear here after clicking 'Preview Raw Contents'..." readonly></textarea>
                </div>

                <div class="section">
                    <h3>‚ú® Parsed Email Output</h3>
                    <textarea id="parsedContent" class="textarea" placeholder="Parsed email content will appear here after clicking 'Send to Backend & Parse'..." readonly></textarea>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                let selectedFile = null;

                // DOM elements
                const fileInput = document.getElementById('fileInput');
                const fileInputWrapper = document.getElementById('fileInputWrapper');
                const fileInfo = document.getElementById('fileInfo');
                const previewBtn = document.getElementById('previewBtn');
                const parseBtn = document.getElementById('parseBtn');
                const rawContent = document.getElementById('rawContent');
                const parsedContent = document.getElementById('parsedContent');
                const statusMessage = document.getElementById('statusMessage');

                // File input event listeners
                fileInput.addEventListener('change', handleFileSelect);
                fileInputWrapper.addEventListener('click', function (event) {
                    // Only trigger file input if clicking on the wrapper itself, not the file input
                    if (event.target !== fileInput) {
                        fileInput.click();
                    }
                });
                fileInputWrapper.addEventListener('dragover', handleDragOver);
                fileInputWrapper.addEventListener('dragleave', handleDragLeave);
                fileInputWrapper.addEventListener('drop', handleDrop);

                // Button event listeners
                previewBtn.addEventListener('click', previewRawContents);
                parseBtn.addEventListener('click', sendToBackend);

                function handleFileSelect(event) {
                    const file = event.target.files[0];
                    processSelectedFile(file);
                }

                function handleDragOver(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.add('dragover');
                }

                function handleDragLeave(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.remove('dragover');
                }

                function handleDrop(event) {
                    event.preventDefault();
                    fileInputWrapper.classList.remove('dragover');
                    const file = event.dataTransfer.files[0];

                    // Sync the file input with the dropped file
                    if (file) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;
                    }

                    processSelectedFile(file);
                }

                function processSelectedFile(file) {
                    if (!file) return;

                    // Validate file type by extension and MIME type
                    const validExtensions = ['.eml', '.msg', '.txt'];
                    const validMimeTypes = ['message/rfc822', 'text/plain', 'application/octet-stream'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

                    const isValidExtension = validExtensions.includes(fileExtension);
                    const isValidMimeType = validMimeTypes.includes(file.type) || file.type === '';

                    if (!isValidExtension) {
                        showMessage('Please select a valid email file (.eml, .msg, or .txt)', 'error');
                        return;
                    }

                    selectedFile = file;

                    // Update file info display
                    fileInfo.style.display = 'block';
                    fileInfo.innerHTML = `
                        <strong>Selected file:</strong> ${file.name}<br>
                        <strong>Size:</strong> ${formatFileSize(file.size)}<br>
                        <strong>Type:</strong> ${file.type || 'Unknown'}
                    `;

                    // Enable buttons
                    previewBtn.disabled = false;
                    parseBtn.disabled = false;

                    // Clear previous content
                    rawContent.value = '';
                    parsedContent.value = '';
                    clearMessage();

                    showMessage('File selected successfully! You can now preview or parse the email.', 'success');
                }

                function previewRawContents() {
                    if (!selectedFile) {
                        showMessage('Please select a file first.', 'error');
                        return;
                    }

                    previewBtn.innerHTML = '<div class="loading"></div>Reading file...';
                    previewBtn.disabled = true;

                    const reader = new FileReader();

                    reader.onload = function (event) {
                        rawContent.value = event.target.result;
                        previewBtn.innerHTML = 'üìÑ Preview Raw Contents';
                        previewBtn.disabled = false;
                        showMessage('Raw content loaded successfully!', 'success');
                    };

                    reader.onerror = function () {
                        showMessage('Error reading file. Please try again.', 'error');
                        previewBtn.innerHTML = 'üìÑ Preview Raw Contents';
                        previewBtn.disabled = false;
                    };

                    reader.readAsText(selectedFile);
                }

                async function sendToBackend() {
                    if (!selectedFile) {
                        showMessage('Please select a file first.', 'error');
                        return;
                    }

                    parseBtn.innerHTML = '<div class="loading"></div>Parsing email...';
                    parseBtn.disabled = true;
                    parsedContent.value = 'Processing...';

                    try {
                        const formData = new FormData();
                        formData.append('file', selectedFile);

                        const response = await fetch('/api/parse-email', {
                            method: 'POST',
                            mode: 'cors',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.status === 'success') {
                                parsedContent.value = result.parsedText;
                                showMessage('Email parsed successfully!', 'success');
                            } else {
                                throw new Error(result.error || 'Unknown error occurred');
                            }
                        } else {
                            const errorResult = await response.json().catch(() => ({ error: 'Unknown server error' }));
                            throw new Error(`Server error (${response.status}): ${errorResult.error}`);
                        }
                    } catch (error) {
                        parsedContent.value = `Error: ${error.message}`;
                        showMessage(`Failed to parse email: ${error.message}`, 'error');
                    } finally {
                        parseBtn.innerHTML = 'üîÑ Send to Backend & Parse';
                        parseBtn.disabled = false;
                    }
                }

                function showMessage(message, type) {
                    const className = type === 'error' ? 'error-message' : 'success-message';
                    statusMessage.innerHTML = `<div class="${className}">${message}</div>`;

                    // Auto-hide success messages after 5 seconds
                    if (type === 'success') {
                        setTimeout(() => {
                            if (statusMessage.innerHTML.includes(message)) {
                                clearMessage();
                            }
                        }, 5000);
                    }
                }

                function clearMessage() {
                    statusMessage.innerHTML = '';
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                // Initialize
                showMessage('Ready to process email files. Select a .eml file to get started.', 'success');
            });
        </script>
    </div>
</body>
</html>