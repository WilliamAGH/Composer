<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout :: layout(~{::body/content}, 'ComposerAI - Email Client', ~{::head/extraHead})}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ComposerAI - Email Client</title>
    <th:block th:fragment="extraHead">
        <style>
            /* Email Client Specific Styles */
            .email-client-container {
                display: flex;
                height: 100vh;
                overflow: hidden;
                background: linear-gradient(180deg, #f8fafc 0%, #f5f5f7 100%);
            }

            .sidebar {
                width: 16rem;
                background: rgba(255, 255, 255, 0.75);
                border-right: 1px solid rgba(226, 232, 240, 0.8);
                -webkit-backdrop-filter: blur(12px);
                backdrop-filter: blur(12px);
                display: flex;
                flex-direction: column;
                transition: transform 0.3s ease;
            }

            .sidebar.closed {
                transform: translateX(-100%);
            }

            .email-list {
                width: 24rem;
                border-right: 1px solid rgba(226, 232, 240, 0.8);
                background: rgba(255, 255, 255, 0.9);
                display: flex;
                flex-direction: column;
            }

            .email-content {
                flex: 1;
                background: rgba(255, 255, 255, 0.95);
                display: flex;
                flex-direction: column;
            }

            .email-item {
                padding: 1rem;
                border-bottom: 1px solid rgba(226, 232, 240, 0.6);
                cursor: pointer;
                transition: background-color 0.15s ease;
            }

            .email-item:hover {
                background: rgba(241, 245, 249, 0.7);
            }

            .email-item.selected {
                background: rgba(226, 232, 240, 0.5);
            }

            .email-item.unread {
                background: rgba(59, 130, 246, 0.03);
            }

            .nav-item {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem;
                border-radius: 0.75rem;
                transition: background-color 0.15s ease;
                text-align: left;
                border: none;
                background: transparent;
                cursor: pointer;
                color: #64748b;
                font-size: 0.95rem;
            }

            .nav-item:hover {
                background: rgba(226, 232, 240, 0.4);
                color: #0f172a;
            }

            .badge {
                margin-left: auto;
                padding: 0.15rem 0.5rem;
                border-radius: 9999px;
                background: rgba(226, 232, 240, 0.6);
                font-size: 0.75rem;
                font-weight: 600;
                color: #475569;
            }

            .compose-window {
                position: fixed;
                bottom: 0;
                right: 1.5rem;
                width: 90%;
                max-width: 560px;
                background: rgba(255, 255, 255, 0.98);
                border-radius: 20px 20px 0 0;
                border: 1px solid rgba(226, 232, 240, 0.8);
                border-bottom: none;
                box-shadow: 0 -10px 40px -10px rgba(15, 23, 42, 0.25);
                overflow: hidden;
                z-index: 1000;
                display: none;
                flex-direction: column;
                max-height: 600px;
                animation: slideUp 0.2s ease-out;
            }

            .compose-window.active {
                display: flex;
            }

            .compose-window.minimized {
                max-height: 48px;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .compose-windows-container {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                pointer-events: none;
                z-index: 1000;
            }

            .compose-windows-container > * {
                pointer-events: auto;
            }

            .ai-command-btn {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0.85rem;
                border-radius: 0.75rem;
                border: 1px solid rgba(226, 232, 240, 0.8);
                background: rgba(255, 255, 255, 0.9);
                font-size: 0.875rem;
                font-weight: 500;
                color: #475569;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .ai-command-btn:hover {
                background: rgba(248, 250, 252, 1);
                border-color: rgba(148, 163, 184, 0.5);
                color: #0f172a;
            }

            .ai-command-btn svg {
                width: 1rem;
                height: 1rem;
            }

            .avatar {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                object-fit: cover;
            }

            .avatar-lg {
                width: 3rem;
                height: 3rem;
            }

            .empty-state {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #94a3b8;
                text-align: center;
            }

            .reply-section {
                padding: 1rem;
                border-top: 1px solid rgba(226, 232, 240, 0.8);
                background: rgba(255, 255, 255, 0.98);
                -webkit-backdrop-filter: blur(8px);
                backdrop-filter: blur(8px);
            }


            .icon {
                width: 1.25rem;
                height: 1.25rem;
                stroke-width: 1.8;
            }

            .icon-sm {
                width: 1rem;
                height: 1rem;
            }

            .label-badge {
                display: inline-block;
                padding: 0.15rem 0.5rem;
                border-radius: 0.5rem;
                background: rgba(226, 232, 240, 0.5);
                font-size: 0.7rem;
                font-weight: 600;
                color: #475569;
            }

            .star-icon {
                fill: none;
                transition: all 0.15s ease;
            }

            .star-icon.starred {
                fill: #facc15;
                stroke: #facc15;
            }

            @media (max-width: 768px) {
                .sidebar {
                    position: absolute;
                    left: 0;
                    top: 0;
                    height: 100%;
                    z-index: 100;
                }
                
                .email-list {
                    width: 20rem;
                }
            }
        </style>
    </th:block>
</head>

<body>
    <div th:fragment="content" class="email-client-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-4 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="h-6 w-6" style="color: #0f172a;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h1 class="text-xl font-bold" style="color: #0f172a;">InboxAI</h1>
                </div>
                <button id="composeBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-semibold transition" 
                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border: none; cursor: pointer;"
                    onmouseover="this.style.background='linear-gradient(135deg, #1e293b 0%, #334155 100%)'"
                    onmouseout="this.style.background='linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9.813 3.063l.75 3.75m3.937-3.75l-.75 3.75m-6 .937l3.75.75m9.375 0l-3.75.75m-9.375 6l3.75-.75m9.375 0l-3.75-.75m-6 5.063l.75-3.75m3.937 3.75l-.75-3.75M12 18.75a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Compose
                </button>
            </div>
            
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-19.5.375h21m-21 3.375h21m-21 3.375h21m-18.75-9.375V6a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0119.5 6v6.75M5.25 18h13.5m-13.5 0a2.25 2.25 0 01-2.25-2.25v-6.75m15.75 9a2.25 2.25 0 002.25-2.25v-6.75m-15.75 0V6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Inbox</span>
                    <span id="inboxBadge" class="badge">1</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Starred</span>
                    <span id="starredBadge" class="badge">1</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Snoozed</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Sent</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Archive</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Trash</span>
                </button>
            </nav>
        </div>

        <!-- Email List -->
        <div class="email-list">
            <div class="p-4 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                <div class="flex items-center gap-2 mb-3">
                    <button id="menuToggle" class="flex items-center justify-center w-10 h-10 rounded-xl border" 
                        style="border-color: rgba(226, 232, 240, 0.8); background: white; cursor: pointer;"
                        aria-label="Toggle sidebar menu"
                        title="Toggle sidebar menu">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4" style="color: #94a3b8;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input id="searchInput" type="text" placeholder="Search emails..." 
                            class="w-full pl-9 pr-3 py-2 border rounded-xl focus:outline-none focus:ring-2" 
                            style="border-color: rgba(226, 232, 240, 0.8); background: white; font-size: 0.875rem;">
                    </div>
                </div>
            </div>
            <div id="emailList" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- Email Content -->
        <div id="emailContent" class="email-content">
            <div class="empty-state">
                <div class="text-center">
                    <svg class="h-16 w-16 mx-auto mb-4" style="opacity: 0.2; color: #94a3b8;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p>Select an email to read</p>
                </div>
            </div>
        </div>

        <!-- Compose Windows Container -->
        <div id="composeWindowsContainer" class="compose-windows-container"></div>

        <script th:inline="javascript">
            const UI_NONCE = /*[[${uiNonce}]]*/ null;

            const SAMPLE_EMAILS = [
                {
                    id: '1',
                    from: 'Sarah Johnson',
                    fromEmail: 'sarah.j@company.com',
                    subject: 'Q4 Marketing Strategy Review',
                    preview: "Hi team, I've compiled the Q4 marketing metrics and would like to schedule...",
                    content: "Hi team, I've compiled the Q4 marketing metrics and would like to schedule a review meeting next week. The campaign performance has exceeded our expectations with a 45% increase in engagement. Let's discuss the strategy for Q1.",
                    timestamp: '10:30 AM',
                    read: false,
                    starred: true,
                    avatar: 'https://i.pravatar.cc/150?img=1',
                    labels: ['Work', 'Important']
                },
                {
                    id: '2',
                    from: 'Michael Chen',
                    fromEmail: 'm.chen@tech.io',
                    subject: 'New Feature Deployment Schedule',
                    preview: "The new authentication system is ready for deployment. Here's the timeline...",
                    content: "The new authentication system is ready for deployment. Here's the timeline we're proposing: staging environment testing on Monday, production deployment on Wednesday. Please review the attached documentation.",
                    timestamp: 'Yesterday',
                    read: true,
                    starred: false,
                    avatar: 'https://i.pravatar.cc/150?img=2',
                    labels: ['Development']
                },
                {
                    id: '3',
                    from: 'Emma Williams',
                    fromEmail: 'emma.w@design.co',
                    subject: 'Design System Updates',
                    preview: "I've updated the component library with the new color palette and typography...",
                    content: "I've updated the component library with the new color palette and typography guidelines. All components now support dark mode out of the box. The documentation has been updated accordingly.",
                    timestamp: '2 days ago',
                    read: true,
                    starred: false,
                    avatar: 'https://i.pravatar.cc/150?img=3',
                    labels: ['Design']
                }
            ];

            class EmailClient {
                constructor() {
                    this.emails = SAMPLE_EMAILS;
                    this.selectedEmail = null;
                    this.sidebarOpen = true;
                    this.composeWindows = [];
                    this.composeWindowIdCounter = 0;
                    
                    this.initializeElements();
                    this.attachEventListeners();
                    this.renderEmailList();
                    this.selectEmail(this.emails[0]);
                }

                initializeElements() {
                    this.sidebar = document.getElementById('sidebar');
                    this.emailList = document.getElementById('emailList');
                    this.emailContent = document.getElementById('emailContent');
                    this.composeWindowsContainer = document.getElementById('composeWindowsContainer');
                    this.menuToggle = document.getElementById('menuToggle');
                    this.composeBtn = document.getElementById('composeBtn');
                    this.searchInput = document.getElementById('searchInput');
                }

                attachEventListeners() {
                    this.menuToggle.addEventListener('click', () => this.toggleSidebar());
                    this.composeBtn.addEventListener('click', () => this.openComposeWindow());
                    this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                }

                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                    this.sidebar.classList.toggle('closed', !this.sidebarOpen);
                }

                openComposeWindow(options = {}) {
                    const windowId = 'compose-window-' + (++this.composeWindowIdCounter);
                    const isReply = options.replyTo !== undefined;
                    const title = isReply ? `Reply to ${options.replyTo}` : 'New Message';
                    
                    const windowHtml = `
                        <div id="${windowId}" class="compose-window active" style="right: ${this.composeWindows.length * 20 + 1.5}rem;">
                            <div class="compose-header p-3 border-b flex items-center justify-between" style="border-color: rgba(226, 232, 240, 0.6); background: rgba(248, 250, 252, 0.95);">
                                <div class="flex items-center gap-2">
                                    <svg class="icon-sm" style="color: #64748b;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        ${isReply ? 
                                            '<path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>' :
                                            '<path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" stroke-linecap="round" stroke-linejoin="round"/>'
                                        }
                                    </svg>
                                    <span class="text-sm font-semibold" style="color: #475569;">${title}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button class="minimize-btn flex items-center justify-center w-7 h-7 rounded-lg transition" 
                                        style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                        onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                        onmouseout="this.style.background='transparent'"
                                        title="Minimize">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M19.5 12h-15" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <button class="close-btn flex items-center justify-center w-7 h-7 rounded-lg transition" 
                                        style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                        onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                        onmouseout="this.style.background='transparent'"
                                        title="Close">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="compose-body p-4 space-y-3 flex-1 overflow-y-auto">
                                ${!isReply ? '<input type="text" class="compose-to w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" placeholder="To" style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;">' : ''}
                                ${!isReply ? '<input type="text" class="compose-subject w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" placeholder="Subject" style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;">' : ''}
                                <div class="flex gap-2 flex-wrap">
                                    <button class="ai-command-btn" onclick="handleComposeAI('${windowId}', 'draft')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9.813 3.063l.75 3.75m3.937-3.75l-.75 3.75m-6 .937l3.75.75m9.375 0l-3.75.75m-9.375 6l3.75-.75m9.375 0l-3.75-.75m-6 5.063l.75-3.75m3.937 3.75l-.75-3.75M12 18.75a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        AI ${isReply ? 'Draft' : 'Compose'}
                                    </button>
                                    <button class="ai-command-btn" onclick="handleComposeAI('${windowId}', 'tone')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Adjust Tone
                                    </button>
                                </div>
                                <textarea class="compose-message w-full px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 resize-none" 
                                    placeholder="Type your ${isReply ? 'reply' : 'message'}..." 
                                    rows="${isReply ? 6 : 8}" 
                                    style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;"></textarea>
                            </div>
                            <div class="compose-footer p-3 border-t flex gap-2" style="border-color: rgba(226, 232, 240, 0.6); background: rgba(248, 250, 252, 0.5);">
                                <button class="send-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition text-sm" 
                                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border: none; cursor: pointer;"
                                    onmouseover="this.style.background='linear-gradient(135deg, #1e293b 0%, #334155 100%)'"
                                    onmouseout="this.style.background='linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Send
                                </button>
                                <button class="attach-btn flex items-center gap-2 px-3 py-2 rounded-lg font-semibold border transition text-sm" 
                                    style="background: white; border-color: rgba(226, 232, 240, 0.8); color: #475569; cursor: pointer;"
                                    onmouseover="this.style.background='rgba(248, 250, 252, 1)'"
                                    onmouseout="this.style.background='white'"
                                    title="Attach file">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Attach
                                </button>
                            </div>
                        </div>
                    `;
                    
                    this.composeWindowsContainer.insertAdjacentHTML('beforeend', windowHtml);
                    const windowElement = document.getElementById(windowId);
                    
                    // Track window
                    this.composeWindows.push({
                        id: windowId,
                        element: windowElement,
                        minimized: false,
                        isReply: isReply
                    });
                    
                    // Ensure default anchored position
                    windowElement.style.left = 'auto';
                    windowElement.style.top = 'auto';
                    windowElement.style.right = '1.5rem';
                    windowElement.style.bottom = '0';

                    // Attach event listeners
                    this.attachComposeWindowListeners(windowId);
                    
                    // Normalize positioning for all windows
                    this.repositionComposeWindows();
                    
                    // Focus first input
                    setTimeout(() => {
                        const firstInput = windowElement.querySelector('input, textarea');
                        if (firstInput) firstInput.focus();
                    }, 100);
                }

                attachComposeWindowListeners(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (!windowElement) return;
                    
                    const window = this.composeWindows.find(w => w.id === windowId);
                    
                    // Close button
                    windowElement.querySelector('.close-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.closeComposeWindow(windowId);
                    });
                    
                    // Minimize button
                    windowElement.querySelector('.minimize-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.minimized = !window.minimized;
                        windowElement.classList.toggle('minimized', window.minimized);
                    });
                    
                    // Send button
                    windowElement.querySelector('.send-btn').addEventListener('click', () => {
                        this.sendFromComposeWindow(windowId);
                    });
                    
                    // Cmd/Ctrl+Enter to send
                    windowElement.querySelector('.compose-message').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                            e.preventDefault();
                            this.sendFromComposeWindow(windowId);
                        }
                    });
                    
                    // Drag support intentionally disabled
                }

                closeComposeWindow(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (windowElement) {
                        windowElement.remove();
                    }
                    this.composeWindows = this.composeWindows.filter(w => w.id !== windowId);
                    this.repositionComposeWindows();
                }

                repositionComposeWindows() {
                    this.composeWindows.forEach((window) => {
                        window.element.style.right = '1.5rem';
                        window.element.style.bottom = '0';
                        window.element.style.left = 'auto';
                        window.element.style.top = 'auto';
                    });
                }

                sendFromComposeWindow(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (!windowElement) return;
                    
                    const window = this.composeWindows.find(w => w.id === windowId);
                    const message = windowElement.querySelector('.compose-message').value.trim();
                    
                    if (window.isReply) {
                        if (message) {
                            console.log('Sending reply:', message);
                            alert('Reply sent successfully!');
                            this.closeComposeWindow(windowId);
                        } else {
                            alert('Please enter a message');
                        }
                    } else {
                        const to = windowElement.querySelector('.compose-to').value.trim();
                        const subject = windowElement.querySelector('.compose-subject').value.trim();
                        
                        if (to && subject && message) {
                            console.log('Sending email:', { to, subject, message });
                            alert('Email sent successfully!');
                            this.closeComposeWindow(windowId);
                        } else {
                            alert('Please fill in all fields');
                        }
                    }
                }

                handleSearch(query) {
                    const filtered = this.emails.filter(email =>
                        email.subject.toLowerCase().includes(query.toLowerCase()) ||
                        email.from.toLowerCase().includes(query.toLowerCase()) ||
                        email.preview.toLowerCase().includes(query.toLowerCase())
                    );
                    this.renderEmailList(filtered);
                }

                renderEmailList(emails = this.emails) {
                    this.emailList.innerHTML = emails.map(email => `
                        <div class="email-item ${email.read ? '' : 'unread'} ${this.selectedEmail?.id === email.id ? 'selected' : ''}" 
                             data-email-id="${email.id}">
                            <div class="flex items-start gap-3">
                                <img src="${email.avatar}" alt="${email.from}" class="avatar">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold truncate" style="color: ${email.read ? '#64748b' : '#0f172a'}; font-size: 0.875rem;">
                                            ${this.escapeHtml(email.from)}
                                        </span>
                                        <span class="text-xs ml-2" style="color: #94a3b8; flex-shrink: 0;">
                                            ${email.timestamp}
                                        </span>
                                    </div>
                                    <p class="text-sm truncate mb-1" style="color: ${email.read ? '#64748b' : '#0f172a'}; font-weight: ${email.read ? '400' : '500'};">
                                        ${this.escapeHtml(email.subject)}
                                    </p>
                                    <p class="text-xs truncate" style="color: #94a3b8;">
                                        ${this.escapeHtml(email.preview)}
                                    </p>
                                    ${email.labels.length > 0 ? `
                                        <div class="flex gap-1 mt-2">
                                            ${email.labels.map(label => `<span class="label-badge">${this.escapeHtml(label)}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <button class="star-btn mt-1" data-email-id="${email.id}" data-starred="${email.starred}">
                                    <svg class="icon-sm star-icon ${email.starred ? 'starred' : ''}" viewBox="0 0 24 24" stroke="currentColor" style="color: ${email.starred ? '#facc15' : '#94a3b8'};">
                                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Attach click handlers
                    this.emailList.querySelectorAll('.email-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (!e.target.closest('.star-btn')) {
                                const emailId = item.dataset.emailId;
                                const email = this.emails.find(e => e.id === emailId);
                                if (email) this.selectEmail(email);
                            }
                        });
                    });

                    this.emailList.querySelectorAll('.star-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.toggleStar(btn.dataset.emailId);
                        });
                    });
                }

                selectEmail(email) {
                    this.selectedEmail = email;
                    email.read = true;
                    this.renderEmailList();
                    this.renderEmailContent(email);
                    this.updateBadges();
                }

                renderEmailContent(email) {
                    this.emailContent.innerHTML = `
                        <div class="flex-1 flex flex-col">
                            <div class="p-6 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-start gap-4">
                                        <img src="${email.avatar}" alt="${email.from}" class="avatar avatar-lg">
                                        <div>
                                            <h2 class="text-xl font-semibold mb-1" style="color: #0f172a;">
                                                ${this.escapeHtml(email.subject)}
                                            </h2>
                                            <div class="flex items-center gap-2 text-sm" style="color: #64748b;">
                                                <span class="font-medium">${this.escapeHtml(email.from)}</span>
                                                <span>&lt;${this.escapeHtml(email.fromEmail)}&gt;</span>
                                            </div>
                                            <p class="text-xs mt-1" style="color: #94a3b8;">
                                                ${email.timestamp}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button id="replyBtn" class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Reply">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Forward">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Archive">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Delete">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="More">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <!-- AI Commands Bar -->
                                <div class="flex gap-2 flex-wrap">
                                    <button class="ai-command-btn" onclick="handleAICommand('summarize')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9.813 3.063l.75 3.75m3.937-3.75l-.75 3.75m-6 .937l3.75.75m9.375 0l-3.75.75m-9.375 6l3.75-.75m9.375 0l-3.75-.75m-6 5.063l.75-3.75m3.937 3.75l-.75-3.75M12 18.75a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Summarize
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('translate')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Translate
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('explain')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Explain
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('draft')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Draft Reply
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 p-6 overflow-y-auto">
                                <div class="prose prose-sm max-w-none">
                                    <p style="color: #0f172a; line-height: 1.65; font-size: 0.95rem;">
                                        ${this.escapeHtml(email.content)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Attach reply handler - opens compose window for reply
                    const replyBtn = document.getElementById('replyBtn');
                    if (replyBtn) {
                        replyBtn.addEventListener('click', () => {
                            this.openComposeWindow({ replyTo: email.from });
                        });
                    }
                }

                toggleStar(emailId) {
                    const email = this.emails.find(e => e.id === emailId);
                    if (email) {
                        email.starred = !email.starred;
                        this.renderEmailList();
                        if (this.selectedEmail?.id === emailId) {
                            this.renderEmailContent(email);
                        }
                        this.updateBadges();
                    }
                }

                updateBadges() {
                    const unreadCount = this.emails.filter(e => !e.read).length;
                    const starredCount = this.emails.filter(e => e.starred).length;
                    
                    const inboxBadge = document.getElementById('inboxBadge');
                    const starredBadge = document.getElementById('starredBadge');
                    
                    if (inboxBadge) inboxBadge.textContent = unreadCount;
                    if (starredBadge) starredBadge.textContent = starredCount;
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            }

            function handleAICommand(command) {
                console.log('AI Command:', command);
                alert(`AI ${command} command triggered! (This would integrate with ComposerAI backend)`);
            }

            function handleComposeAI(windowId, command) {
                console.log('Compose AI Command:', windowId, command);
                const windowElement = document.getElementById(windowId);
                if (!windowElement) return;
                
                const textarea = windowElement.querySelector('.compose-message');
                if (textarea && command === 'draft') {
                    textarea.value = 'Thank you for your email. I\'ll review this and get back to you shortly.\n\nBest regards';
                } else {
                    alert(`AI ${command} triggered! (This would integrate with ComposerAI backend)`);
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                new EmailClient();
            });
        </script>
    </div>
</body>

</html>

