<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout :: layout(~{::body/content}, 'ComposerAI - Email Client', ~{::head/extraHead})}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ComposerAI - Email Client</title>
    <th:block th:fragment="extraHead">
        <link rel="stylesheet" href="/css/email-client.css">
    </th:block>
</head>

<body>
    <div th:fragment="content" class="email-client-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header p-4 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="h-6 w-6" style="color: #0f172a;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h1 class="text-xl font-bold" style="color: #0f172a;">ComposerAI</h1>
                </div>
                <button id="composeBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl font-semibold transition"
                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border: none; cursor: pointer;"
                    onmouseover="this.style.background='linear-gradient(135deg, #1e293b 0%, #334155 100%)'"
                    onmouseout="this.style.background='linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Compose
                </button>
            </div>
            
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-19.5.375h21m-21 3.375h21m-21 3.375h21m-18.75-9.375V6a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0119.5 6v6.75M5.25 18h13.5m-13.5 0a2.25 2.25 0 01-2.25-2.25v-6.75m15.75 9a2.25 2.25 0 002.25-2.25v-6.75m-15.75 0V6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Inbox</span>
                    <span id="inboxBadge" class="badge">1</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Starred</span>
                    <span id="starredBadge" class="badge">1</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Snoozed</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Sent</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Archive</span>
                </button>
                <button class="nav-item">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="flex: 1;">Trash</span>
                </button>
            </nav>
        </div>

        <!-- Email List -->
        <div class="email-list">
            <div class="email-list-header px-4 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                <div class="email-list-toolbar flex items-center gap-3">
                    <button id="menuToggle" class="flex items-center justify-center w-10 h-10 rounded-xl border" 
                        style="border-color: rgba(226, 232, 240, 0.8); background: white; cursor: pointer;"
                        aria-label="Toggle sidebar menu"
                        title="Toggle sidebar menu">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4" style="color: #94a3b8;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input id="searchInput" type="text" placeholder="Search emails..." 
                            class="w-full pl-9 pr-3 py-2 border rounded-xl focus:outline-none focus:ring-2" 
                            style="border-color: rgba(226, 232, 240, 0.8); background: white; font-size: 0.875rem;">
                    </div>
                </div>
            </div>
            <div id="emailList" class="flex-1 overflow-y-auto"></div>
        </div>

        <!-- Email Content -->
        <div id="emailContent" class="email-content">
            <div class="empty-state">
                <div class="text-center">
                    <svg class="h-16 w-16 mx-auto mb-4" style="opacity: 0.2; color: #94a3b8;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p>Select an email to read</p>
                </div>
            </div>
        </div>

        <!-- Compose Windows Container -->
        <div id="composeWindowsContainer" class="compose-windows-container"></div>

        <script th:inline="javascript">
            const UI_NONCE = /*[[${uiNonce}]]*/ null;
            const EMAIL_RENDER_MODES = /*[[${emailRenderModes}]]*/ {};
            const EMAIL_RENDER_MODE = (/*[[${emailRenderMode}]]*/ 'HTML').toUpperCase();
            const EMAIL_MESSAGES = /*[[${emailMessages}]]*/ [];

            function deriveAvatarUrl(emailMessage) {
                if (emailMessage.avatarUrl) {
                    return emailMessage.avatarUrl;
                }
                if (emailMessage.companyLogoUrl) {
                    return emailMessage.companyLogoUrl;
                }
                const seed = (emailMessage.senderEmail || emailMessage.senderName || 'unknown').trim();
                const hash = Array.from(seed).reduce((acc, char) => acc + char.charCodeAt(0), 0) % 70;
                return `https://i.pravatar.cc/150?img=${hash + 1}`;
            }

            function deriveTimestampDisplay(message) {
                if (message.receivedTimestampDisplay) {
                    return message.receivedTimestampDisplay;
                }
                if (message.receivedTimestampIso) {
                    try {
                        const date = new Date(message.receivedTimestampIso);
                        if (!Number.isNaN(date.getTime())) {
                            return date.toLocaleString();
                        }
                    } catch (error) {
                        // no-op fallback
                    }
                }
                return '';
            }

            function buildEmailPreview(message) {
                if (message.preview) {
                    return message.preview;
                }
                const source = message.emailBodyTransformedText || '';
                const normalized = source.trim().replace(/\s+/g, ' ');
                if (normalized.length <= 180) {
                    return normalized;
                }
                return `${normalized.slice(0, 177)}...`;
            }

            function buildEmailContextString(email) {
                if (!email) {
                    return '';
                }
                const lines = [];
                const subject = email.subject || 'No subject';
                const fromName = email.from || email.fromEmail || 'Unknown sender';
                const fromEmail = email.fromEmail ? ` <${email.fromEmail}>` : '';
                const toName = email.to || email.toEmail || '';
                const toEmail = email.toEmail ? ` <${email.toEmail}>` : '';
                const timestamp = email.timestamp || 'Unknown date';

                lines.push('=== Email Metadata ===');
                lines.push(`Subject: ${subject}`);
                lines.push(`From: ${fromName}${fromEmail}`);
                if (toName || toEmail) {
                    lines.push(`To: ${(toName || 'Unknown recipient')}${toEmail}`);
                }
                lines.push(`Email sent on: ${timestamp}`);
                if (email.timestampIso) {
                    lines.push(`Email sent (ISO): ${email.timestampIso}`);
                }
                lines.push('');
                lines.push('=== Email Body ===');
                const body = (email.contentMarkdown && email.contentMarkdown.trim().length > 0)
                    ? email.contentMarkdown.trim()
                    : (email.contentText && email.contentText.trim().length > 0)
                        ? email.contentText.trim()
                        : (email.content && email.content.trim().length > 0)
                            ? email.content.trim()
                            : '(Email body is empty)';
                lines.push(body);
                return lines.join('\n');
            }

            function mapEmailMessageToClientModel(message, index) {
                const contentMarkdown = message.emailBodyTransformedMarkdown || '';
                const contentText = message.emailBodyTransformedText || '';
                const contentHtml = typeof message.emailBodyHtml === 'string' && message.emailBodyHtml.trim().length > 0
                    ? message.emailBodyHtml
                    : null;
                return {
                    id: message.id || message.contextId || `email-${index + 1}`,
                    from: message.senderName || message.senderEmail || 'Unknown sender',
                    fromEmail: message.senderEmail || '',
                    to: message.recipientName || message.recipientEmail || '',
                    toEmail: message.recipientEmail || '',
                    subject: message.subject || 'No subject',
                    preview: buildEmailPreview(message),
                    content: contentText,
                    contentText,
                    contentMarkdown,
                    contentHtml,
                    timestamp: deriveTimestampDisplay(message),
                    timestampIso: message.receivedTimestampIso || null,
                    read: index > 0,
                    starred: false,
                    avatar: deriveAvatarUrl(message),
                    labels: Array.isArray(message.labels) ? message.labels : [],
                    contextId: message.contextId || null
                };
            }

            const FALLBACK_SAMPLE_EMAILS = [
                {
                    id: 'sample-1',
                    from: 'ComposerAI',
                    fromEmail: 'hello@composerai.app',
                    to: 'ComposerAI Team',
                    toEmail: 'hello@composerai.app',
                    subject: 'Welcome to ComposerAI',
                    preview: 'Compose, summarize, and translate your inbox with AI-powered workflows.',
                    content: 'Welcome to ComposerAI! Upload emails, connect your inbox, and unlock AI-powered compose, summarize, and translate workflows.',
                    contentText: 'Welcome to ComposerAI! Upload emails, connect your inbox, and unlock AI-powered compose, summarize, and translate workflows.',
                    contentMarkdown: '',
                    contentHtml: null,
                    timestamp: 'Just now',
                    read: false,
                    starred: true,
                    avatar: 'https://i.pravatar.cc/150?img=5',
                    labels: ['Product'],
                    contextId: null
                }
            ];

            class EmailClient {
                constructor() {
                    const serverMessages = Array.isArray(EMAIL_MESSAGES) ? EMAIL_MESSAGES : [];
                    this.originalMessages = serverMessages;
                    const mappedEmails = serverMessages.map((message, index) => mapEmailMessageToClientModel(message, index));
                    const seedEmails = mappedEmails.length > 0 ? mappedEmails : FALLBACK_SAMPLE_EMAILS;
                    this.emails = seedEmails.map(email => ({ ...email }));
                    this.selectedEmail = null;
                    this.sidebarOpen = true;
                    this.composeWindows = [];
                    this.composeWindowIdCounter = 0;
                    this.conversationId = (self.crypto?.randomUUID?.() ?? `conv-${Date.now()}`);
                    this.defaultMaxResults = 5;
                    this.supportedCommands = new Set(['compose', 'draft', 'summarize', 'translate', 'tone']);
                    this.commandDefaults = {
                        summarize: 'Summarize the selected email in a few concise paragraphs, highlighting key actions.',
                        translate: 'Translate the selected email into English.',
                        draft: 'Draft a courteous reply to the selected email outlining next steps.',
                        compose: 'Compose a helpful email response based on the selected email.',
                        tone: 'Adjust the email to a friendly but professional tone.',
                        explain: 'Explain the selected email in clear, plain language so the intent is easy to understand.'
                    };
                    this.commandTitles = {
                        summarize: 'AI Summary',
                        translate: 'AI Translation',
                        draft: 'AI Draft Reply',
                        compose: 'AI Compose',
                        tone: 'AI Tone Adjustment',
                        explain: 'AI Explanation'
                    };
                    this.aiResponsePanel = null;
                    
                    this.initializeElements();
                    this.updateSidebarState();
                    this.attachEventListeners();
                    this.renderEmailList();
                    if (this.emails.length > 0) {
                        this.selectEmail(this.emails[0]);
                    }
                }

                initializeElements() {
                    this.container = document.querySelector('.email-client-container');
                    this.sidebar = document.getElementById('sidebar');
                    this.emailList = document.getElementById('emailList');
                    this.emailContent = document.getElementById('emailContent');
                    this.composeWindowsContainer = document.getElementById('composeWindowsContainer');
                    this.menuToggle = document.getElementById('menuToggle');
                    this.composeBtn = document.getElementById('composeBtn');
                    this.searchInput = document.getElementById('searchInput');
                }

                attachEventListeners() {
                    this.menuToggle.addEventListener('click', () => this.toggleSidebar());
                    this.composeBtn.addEventListener('click', () => this.openComposeWindow());
                    this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                }

                updateSidebarState() {
                    const isCollapsed = !this.sidebarOpen;
                    if (this.sidebar) {
                        this.sidebar.classList.toggle('closed', isCollapsed);
                    }
                    if (this.container) {
                        this.container.classList.toggle('sidebar-collapsed', isCollapsed);
                        this.container.classList.toggle('sidebar-open', !isCollapsed);
                    }
                }

                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                    this.updateSidebarState();
                }

                openComposeWindow(options = {}) {
                    const windowId = 'compose-window-' + (++this.composeWindowIdCounter);
                    const isReply = options.replyTo !== undefined;
                    const title = isReply ? `Reply to ${options.replyTo}` : 'New Message';
                    
                    const windowHtml = `
                        <div id="${windowId}" class="compose-window active" style="right: ${this.composeWindows.length * 20 + 1.5}rem;">
                            <div class="compose-header p-3 border-b flex items-center justify-between" style="border-color: rgba(226, 232, 240, 0.6); background: rgba(248, 250, 252, 0.95);">
                                <div class="flex items-center gap-2">
                                    <svg class="icon-sm" style="color: #64748b;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        ${isReply ? 
                                            '<path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>' :
                                            '<path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" stroke-linecap="round" stroke-linejoin="round"/>'
                                        }
                                    </svg>
                                    <span class="text-sm font-semibold" style="color: #475569;">${title}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button class="minimize-btn flex items-center justify-center w-7 h-7 rounded-lg transition" 
                                        style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                        onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                        onmouseout="this.style.background='transparent'"
                                        title="Minimize">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M19.5 12h-15" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <button class="close-btn flex items-center justify-center w-7 h-7 rounded-lg transition" 
                                        style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                        onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                        onmouseout="this.style.background='transparent'"
                                        title="Close">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="compose-body p-4 space-y-3 flex-1 overflow-y-auto">
                                ${!isReply ? '<input type="text" class="compose-to w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" placeholder="To" style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;">' : ''}
                                <input type="text" class="compose-subject w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" placeholder="Subject" style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;">
                                <div class="flex gap-2 flex-wrap">
                                    <button class="ai-command-btn" onclick="handleComposeAI('${windowId}', 'draft')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9.813 3.063l.75 3.75m3.937-3.75l-.75 3.75m-6 .937l3.75.75m9.375 0l-3.75.75m-9.375 6l3.75-.75m9.375 0l-3.75-.75m-6 5.063l.75-3.75m3.937 3.75l-.75-3.75M12 18.75a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        AI ${isReply ? 'Draft' : 'Compose'}
                                    </button>
                                    <button class="ai-command-btn" onclick="handleComposeAI('${windowId}', 'tone')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Adjust Tone
                                    </button>
                                </div>
                                <textarea class="compose-message w-full px-3 py-3 border rounded-lg focus:outline-none focus:ring-2 resize-none" 
                                    placeholder="Type your ${isReply ? 'reply' : 'message'}..." 
                                    rows="${isReply ? 6 : 8}" 
                                    style="border-color: rgba(226, 232, 240, 0.8); font-size: 0.875rem;"></textarea>
                                <div class="compose-attachments hidden bg-white/70 border rounded-lg px-3 py-2 text-xs" 
                                    style="border-color: rgba(226, 232, 240, 0.6); color: #475569;">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="uppercase font-semibold tracking-wide" style="letter-spacing: 0.08em; font-size: 0.65rem;">Attachments</span>
                                        <span class="compose-attachments-count" style="font-size: 0.65rem;"></span>
                                    </div>
                                    <ul class="compose-attachments-list space-y-1"></ul>
                                </div>
                            </div>
                            <div class="compose-footer p-3 border-t flex gap-2" style="border-color: rgba(226, 232, 240, 0.6); background: rgba(248, 250, 252, 0.5);">
                                <button class="send-btn flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition text-sm" 
                                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border: none; cursor: pointer;"
                                    onmouseover="this.style.background='linear-gradient(135deg, #1e293b 0%, #334155 100%)'"
                                    onmouseout="this.style.background='linear-gradient(135deg, #0f172a 0%, #1e293b 100%)'">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Send
                                </button>
                                <label class="attach-btn flex items-center gap-2 px-3 py-2 rounded-lg font-semibold border transition text-sm cursor-pointer" 
                                    style="background: white; border-color: rgba(226, 232, 240, 0.8); color: #475569;"
                                    onmouseover="this.style.background='rgba(248, 250, 252, 1)'"
                                    onmouseout="this.style.background='white'"
                                    title="Attach file">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Attach
                                    <input type="file" class="compose-attachment-input sr-only" accept=".eml,.msg,.txt,.pdf,.doc,.docx,.ppt,.pptx,.html,.md" />
                                </label>
                            </div>
                        </div>
                    `;
                    
                    this.composeWindowsContainer.insertAdjacentHTML('beforeend', windowHtml);
                    const windowElement = document.getElementById(windowId);
                    
                    // Track window
                    this.composeWindows.push({
                        id: windowId,
                        element: windowElement,
                        minimized: false,
                        isReply: isReply,
                        relatedEmailId: options.emailId || null,
                        attachments: [],
                        attachmentCounter: 0
                    });
                    
                    // Ensure default anchored position
                    windowElement.style.left = 'auto';
                    windowElement.style.top = 'auto';
                    windowElement.style.right = '1.5rem';
                    windowElement.style.bottom = '0';

                    // Attach event listeners
                    this.attachComposeWindowListeners(windowId);
                    
                    // Normalize positioning for all windows
                    this.repositionComposeWindows();
                    
                    // Focus first input
                    setTimeout(() => {
                        const firstInput = windowElement.querySelector('input, textarea');
                        if (firstInput) firstInput.focus();
                    }, 100);

                    return this.composeWindows[this.composeWindows.length - 1];
                }

                attachComposeWindowListeners(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (!windowElement) return;
                    
                    const window = this.composeWindows.find(w => w.id === windowId);
                    const attachmentsList = windowElement.querySelector('.compose-attachments-list');
                    
                    // Close button
                    windowElement.querySelector('.close-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.closeComposeWindow(windowId);
                    });
                    
                    // Minimize button
                    windowElement.querySelector('.minimize-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.minimized = !window.minimized;
                        windowElement.classList.toggle('minimized', window.minimized);
                    });
                    
                    // Send button
                    windowElement.querySelector('.send-btn').addEventListener('click', () => {
                        this.sendFromComposeWindow(windowId);
                    });
                    
                    // Attachment remove delegation
                    if (attachmentsList) {
                        attachmentsList.addEventListener('click', (e) => {
                            const removeButton = e.target.closest('[data-remove-attachment]');
                            if (removeButton) {
                                e.preventDefault();
                                const attachmentId = removeButton.getAttribute('data-remove-attachment');
                                this.removeAttachmentFromWindow(windowId, attachmentId);
                            }
                        });
                    }

                    // Attach file button handler via shared FileUploadHandler abstraction
                    const attachButton = windowElement.querySelector('.attach-btn');
                    const attachmentInput = windowElement.querySelector('.compose-attachment-input');
                    if (attachButton && attachmentInput && window.ComposerAI?.FileUploadHandler) {
                        try {
                            new window.ComposerAI.FileUploadHandler({
                                dropArea: attachButton,
                                fileInput: attachmentInput,
                                onFileSelected: (file) => {
                                    attachmentInput.value = '';
                                    this.handleComposeAttachment(windowId, file);
                                },
                                validExtensions: ['.eml', '.msg', '.txt', '.pdf', '.doc', '.docx', '.ppt', '.pptx', '.html', '.md']
                            });
                        } catch (error) {
                            console.error('Failed to initialize attachment handler for compose window', error);
                        }
                    }

                    // Cmd/Ctrl+Enter to send
                    windowElement.querySelector('.compose-message').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                            e.preventDefault();
                            this.sendFromComposeWindow(windowId);
                        }
                    });
                    
                    // Drag support intentionally disabled
                }

                handleComposeAttachment(windowId, file) {
                    if (!file) {
                        return;
                    }
                    try {
                        this.addAttachmentToWindow(windowId, file);
                    } catch (error) {
                        console.error('Failed to attach file', error);
                        alert((error && error.message) ? error.message : 'Unable to attach file.');
                    }
                }

                addAttachmentToWindow(windowId, file) {
                    const composeWindow = this.composeWindows.find(w => w.id === windowId);
                    if (!composeWindow) {
                        throw new Error('Compose window not found.');
                    }
                    if (!composeWindow.attachments) {
                        composeWindow.attachments = [];
                    }
                    composeWindow.attachmentCounter = (composeWindow.attachmentCounter || 0) + 1;
                    const attachmentId = `${windowId}-attachment-${composeWindow.attachmentCounter}`;
                    composeWindow.attachments.push({
                        id: attachmentId,
                        file,
                        name: (file && file.name) ? file.name : 'Attachment',
                        size: (file && typeof file.size === 'number') ? file.size : 0
                    });
                    this.renderComposeAttachments(windowId);
                }

                renderComposeAttachments(windowId) {
                    const composeWindow = this.composeWindows.find(w => w.id === windowId);
                    if (!composeWindow) {
                        return;
                    }
                    const windowElement = document.getElementById(windowId);
                    if (!windowElement) {
                        return;
                    }
                    const container = windowElement.querySelector('.compose-attachments');
                    const list = windowElement.querySelector('.compose-attachments-list');
                    const countLabel = windowElement.querySelector('.compose-attachments-count');
                    if (!container || !list) {
                        return;
                    }

                    const attachments = composeWindow.attachments || [];
                    if (attachments.length === 0) {
                        container.classList.add('hidden');
                        list.innerHTML = '';
                        if (countLabel) {
                            countLabel.textContent = '';
                        }
                        return;
                    }

                    const markup = attachments.map((attachment) => {
                        const safeName = window.ComposerAI?.escapeHtml
                            ? window.ComposerAI.escapeHtml(attachment.name || 'Attachment')
                            : (attachment.name || 'Attachment');
                        const sizeLabel = (typeof attachment.size === 'number' && window.ComposerAI?.formatFileSize)
                            ? window.ComposerAI.formatFileSize(attachment.size)
                            : '';
                        return `
                            <li class="compose-attachment-item flex items-center justify-between gap-3 rounded-lg border border-slate-200/80 bg-white/90 px-3 py-2 shadow-sm">
                                <div class="flex items-center gap-3 min-w-0">
                                    <svg class="icon-sm flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: #0f172a;">
                                        <path d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                    <div class="min-w-0">
                                        <p class="truncate font-semibold" style="font-size: 0.75rem;">${safeName}</p>
                                        ${sizeLabel ? `<p class="text-slate-500" style="font-size: 0.65rem;">${sizeLabel}</p>` : ''}
                                    </div>
                                </div>
                                <button type="button" class="remove-attachment text-slate-500 hover:text-slate-800 transition" data-remove-attachment="${attachment.id}" title="Remove attachment">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </li>
                        `;
                    }).join('');

                    list.innerHTML = markup;
                    container.classList.remove('hidden');
                    if (countLabel) {
                        countLabel.textContent = `${attachments.length} file${attachments.length === 1 ? '' : 's'}`;
                    }
                }

                removeAttachmentFromWindow(windowId, attachmentId) {
                    const composeWindow = this.composeWindows.find(w => w.id === windowId);
                    if (!composeWindow || !composeWindow.attachments) {
                        return;
                    }
                    composeWindow.attachments = composeWindow.attachments.filter(att => att.id !== attachmentId);
                    this.renderComposeAttachments(windowId);
                }

                closeComposeWindow(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (windowElement) {
                        windowElement.remove();
                    }
                    this.composeWindows = this.composeWindows.filter(w => w.id !== windowId);
                    this.repositionComposeWindows();
                }

                repositionComposeWindows() {
                    this.composeWindows.forEach((window) => {
                        window.element.style.right = '1.5rem';
                        window.element.style.bottom = '0';
                        window.element.style.left = 'auto';
                        window.element.style.top = 'auto';
                    });
                }

                sendFromComposeWindow(windowId) {
                    const windowElement = document.getElementById(windowId);
                    if (!windowElement) return;

                    const window = this.composeWindows.find(w => w.id === windowId);
                    if (!window) {
                        console.warn('Compose window not found when attempting to send.', windowId);
                        return;
                    }
                    const message = windowElement.querySelector('.compose-message').value.trim();
                    const subject = windowElement.querySelector('.compose-subject').value.trim();
                    const attachments = Array.isArray(window.attachments)
                        ? window.attachments.map(att => ({
                            name: att.name,
                            size: att.size
                        }))
                        : [];

                    if (window.isReply) {
                        if (subject && message) {
                            console.log('Sending reply:', { subject, message, attachments });
                            alert('Reply sent successfully!');
                            this.closeComposeWindow(windowId);
                        } else {
                            alert('Please enter subject and message');
                        }
                    } else {
                        const to = windowElement.querySelector('.compose-to').value.trim();

                        if (to && subject && message) {
                            console.log('Sending email:', { to, subject, message, attachments });
                            alert('Email sent successfully!');
                            this.closeComposeWindow(windowId);
                        } else {
                            alert('Please fill in all fields');
                        }
                    }
                }

                handleSearch(query) {
                    const filtered = this.emails.filter(email =>
                        email.subject.toLowerCase().includes(query.toLowerCase()) ||
                        email.from.toLowerCase().includes(query.toLowerCase()) ||
                        email.preview.toLowerCase().includes(query.toLowerCase())
                    );
                    this.renderEmailList(filtered);
                }

                renderEmailList(emails = this.emails) {
                    this.emailList.innerHTML = emails.map(email => `
                        <div class="email-item ${email.read ? '' : 'unread'} ${this.selectedEmail?.id === email.id ? 'selected' : ''}" 
                             data-email-id="${email.id}">
                            <div class="flex items-start gap-3">
                                <img src="${email.avatar}" alt="${email.from}" class="avatar">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold truncate" style="color: ${email.read ? '#64748b' : '#0f172a'}; font-size: 0.875rem;">
                                            ${window.ComposerAI.escapeHtml(email.from)}
                                        </span>
                                        <span class="text-xs ml-2" style="color: #94a3b8; flex-shrink: 0;">
                                            ${email.timestamp}
                                        </span>
                                    </div>
                                    <p class="text-sm truncate mb-1" style="color: ${email.read ? '#64748b' : '#0f172a'}; font-weight: ${email.read ? '400' : '500'};">
                                        ${window.ComposerAI.escapeHtml(email.subject)}
                                    </p>
                                    <p class="text-xs truncate" style="color: #94a3b8;">
                                        ${window.ComposerAI.escapeHtml(email.preview)}
                                    </p>
                                    ${email.labels.length > 0 ? `
                                        <div class="flex gap-1 mt-2">
                                            ${email.labels.map(label => `<span class="label-badge">${window.ComposerAI.escapeHtml(label)}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <button class="star-btn mt-1" data-email-id="${email.id}" data-starred="${email.starred}">
                                    <svg class="icon-sm star-icon ${email.starred ? 'starred' : ''}" viewBox="0 0 24 24" stroke="currentColor" style="color: ${email.starred ? '#facc15' : '#94a3b8'};">
                                        <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Attach click handlers
                    this.emailList.querySelectorAll('.email-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (!e.target.closest('.star-btn')) {
                                const emailId = item.dataset.emailId;
                                const email = this.emails.find(e => e.id === emailId);
                                if (email) this.selectEmail(email);
                            }
                        });
                    });

                    this.emailList.querySelectorAll('.star-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.toggleStar(btn.dataset.emailId);
                        });
                    });
                }

                selectEmail(email) {
                    this.selectedEmail = email;
                    email.read = true;
                    this.renderEmailList();
                    this.renderEmailContent(email);
                    this.updateBadges();
                }

                renderEmailContent(email) {
                    this.emailContent.innerHTML = `
                        <div class="flex-1 flex flex-col">
                            <div class="p-6 border-b" style="border-color: rgba(226, 232, 240, 0.6);">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-start gap-4">
                                        <img src="${email.avatar}" alt="${email.from}" class="avatar avatar-lg">
                                        <div>
                                            <h2 class="text-xl font-semibold mb-1" style="color: #0f172a;">
                                                ${window.ComposerAI.escapeHtml(email.subject)}
                                            </h2>
                                            <div class="flex items-center gap-2 text-sm" style="color: #64748b;">
                                                <span class="font-medium">${window.ComposerAI.escapeHtml(email.from)}</span>
                                                <span>&lt;${window.ComposerAI.escapeHtml(email.fromEmail)}&gt;</span>
                                            </div>
                                            ${(email.to || email.toEmail) ? `
                                            <div class="flex items-center gap-2 text-xs mt-1" style="color: #94a3b8;">
                                                <span>To:</span>
                                                <span>${window.ComposerAI.escapeHtml(email.to || 'Unknown recipient')}</span>
                                                ${email.toEmail ? `<span>&lt;${window.ComposerAI.escapeHtml(email.toEmail)}&gt;</span>` : ''}
                                            </div>` : ''}
                                            <p class="text-xs mt-1" style="color: #94a3b8;">
                                                ${email.timestamp}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button id="replyBtn" class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Reply">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Forward">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Archive">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="Delete">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="flex items-center justify-center w-9 h-9 rounded-lg transition" 
                                            style="background: transparent; border: none; cursor: pointer; color: #64748b;"
                                            onmouseover="this.style.background='rgba(226, 232, 240, 0.4)'"
                                            onmouseout="this.style.background='transparent'"
                                            title="More">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <!-- AI Commands Bar -->
                                <div class="flex gap-2 flex-wrap">
                                    <button class="ai-command-btn" onclick="handleAICommand('summarize')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9.813 3.063l.75 3.75m3.937-3.75l-.75 3.75m-6 .937l3.75.75m9.375 0l-3.75.75m-9.375 6l3.75-.75m9.375 0l-3.75-.75m-6 5.063l.75-3.75m3.937 3.75l-.75-3.75M12 18.75a6.75 6.75 0 100-13.5 6.75 6.75 0 000 13.5z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Summarize
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('translate')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Translate
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('explain')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Explain
                                    </button>
                                    <button class="ai-command-btn" onclick="handleAICommand('draft')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Draft Reply
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 p-6 overflow-y-auto">
                                <div class="email-body-container" data-role="email-body-container" style="position: relative; contain: layout style paint; isolation: isolate; overflow: hidden;">
                                    <div class="prose prose-sm max-w-none" data-role="email-body" style="color: #0f172a; line-height: 1.65; font-size: 0.95rem;">
                                    </div>
                                </div>
                            </div>
                            <div id="aiResponsePanel" class="border-t" style="border-color: rgba(226, 232, 240, 0.8); background: rgba(248, 250, 252, 0.65); padding: 1.5rem; display: none;">
                                <div class="flex items-center justify-between gap-2">
                                    <div data-role="ai-response-title" class="text-sm font-semibold" style="color: #475569;">AI Assistant</div>
                                    <button type="button" data-role="ai-response-close" class="text-xs font-semibold px-2 py-1 rounded-lg" 
                                        style="color: #64748b; background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(226, 232, 240, 0.8);">
                                        Clear
                                    </button>
                                </div>
                                <div data-role="ai-response-body" class="prose prose-sm max-w-none mt-3 text-slate-700"></div>
                            </div>
                        </div>
                    `;

                    const bodyContainer = this.emailContent.querySelector('[data-role="email-body"]');
                    const bodyContainerWrapper = this.emailContent.querySelector('[data-role="email-body-container"]');
                    if (bodyContainer && bodyContainerWrapper) {
                        const applyProse = EMAIL_RENDER_MODE === (EMAIL_RENDER_MODES.MARKDOWN || 'MARKDOWN');
                        bodyContainer.classList.toggle('prose', applyProse);
                        bodyContainer.classList.toggle('prose-sm', applyProse);

                        if (email.contentHtml) {
                            // Use sandboxed iframe for complete isolation
                            EmailRenderer.renderInIframe(bodyContainerWrapper, email.contentHtml);
                        } else {
                            // Safe plaintext rendering
                            bodyContainer.style.whiteSpace = 'pre-wrap';
                            const fallbackText = email.contentText || email.content || '';
                            bodyContainer.textContent = fallbackText;
                            bodyContainer.style.display = 'block';
                        }
                    }

                    // Attach reply handler - opens compose window for reply
                    const replyBtn = document.getElementById('replyBtn');
                    if (replyBtn) {
                        replyBtn.addEventListener('click', () => {
                            this.openComposeWindow({ replyTo: email.from, emailId: email.id });
                        });
                    }

                    const aiPanel = document.getElementById('aiResponsePanel');
                    if (aiPanel) {
                        this.aiResponsePanel = aiPanel;
                        const closeBtn = aiPanel.querySelector('[data-role="ai-response-close"]');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', () => this.clearAiResponse());
                        }
                    }
                    this.clearAiResponse();
                }

                toggleStar(emailId) {
                    const email = this.emails.find(e => e.id === emailId);
                    if (email) {
                        email.starred = !email.starred;
                        this.renderEmailList();
                        if (this.selectedEmail?.id === emailId) {
                            this.renderEmailContent(email);
                        }
                        this.updateBadges();
                    }
                }

                updateBadges() {
                    const unreadCount = this.emails.filter(e => !e.read).length;
                    const starredCount = this.emails.filter(e => e.starred).length;
                    
                    const inboxBadge = document.getElementById('inboxBadge');
                    const starredBadge = document.getElementById('starredBadge');
                    
                    if (inboxBadge) inboxBadge.textContent = unreadCount;
                    if (starredBadge) starredBadge.textContent = starredCount;
                }

                async triggerAiCommand(command) {
                    if (!this.selectedEmail) {
                        alert('Select an email first.');
                        return;
                    }

                    const title = this.getTitleForCommand(command);
                    const instruction = this.buildInstructionForCommand(command);
                    this.setMainCommandButtonsDisabled(true);
                    this.setAiResponseState({ status: 'loading', title });
                    try {
                        const data = await this.callAiCommand(command, instruction, { contextId: this.selectedEmail?.contextId });
                        if (command === 'draft') {
                            const draftText = this.extractPlainTextFromResponse(data);
                            this.applyAiDraftToCompose(draftText, title);
                        } else {
                            const html = this.extractHtmlFromResponse(data);
                            this.setAiResponseState({ status: 'success', title, html });
                        }
                    } catch (error) {
                        const message = error?.message || 'Unable to complete request.';
                        this.setAiResponseState({ status: 'error', title, message });
                    } finally {
                        this.setMainCommandButtonsDisabled(false);
                    }
                }

                ensureReplyWindowForSelectedEmail() {
                    if (!this.selectedEmail) {
                        return null;
                    }
                    let composeWindow = this.composeWindows.find(w => w.isReply && w.relatedEmailId === this.selectedEmail.id);
                    if (!composeWindow) {
                        composeWindow = this.openComposeWindow({
                            replyTo: this.selectedEmail.from,
                            emailId: this.selectedEmail.id
                        });
                    }
                    if (composeWindow && composeWindow.element) {
                        composeWindow.minimized = false;
                        composeWindow.element.classList.remove('minimized');
                        composeWindow.element.classList.add('active');
                        const textarea = composeWindow.element.querySelector('.compose-message');
                        if (textarea) {
                            textarea.focus();
                        }
                    }
                    return composeWindow;
                }

                applyAiDraftToCompose(draftText, title) {
                    const composeWindow = this.ensureReplyWindowForSelectedEmail();
                    if (!composeWindow) {
                        this.setAiResponseState({
                            status: 'error',
                            title,
                            message: 'Unable to open compose window for draft reply.'
                        });
                        return;
                    }

                    if (!draftText || draftText.trim().length === 0) {
                        this.setAiResponseState({
                            status: 'error',
                            title,
                            message: 'AI returned an empty draft. Try again or refine the request.'
                        });
                        return;
                    }

                    const textarea = composeWindow.element.querySelector('.compose-message');
                    const subjectInput = composeWindow.element.querySelector('.compose-subject');
                    if (!textarea) {
                        this.setAiResponseState({
                            status: 'error',
                            title,
                            message: 'Composer textarea is unavailable.'
                        });
                        return;
                    }

                    const parsed = this.parseSubjectAndBody(draftText);
                    if (subjectInput && parsed.subject) {
                        subjectInput.value = parsed.subject;
                    }
                    textarea.value = parsed.body;
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);

                    this.setAiResponseState({
                        status: 'success',
                        title,
                        html: '<div class="text-sm text-slate-600">Draft inserted into the reply composer. Review and edit before sending.</div>'
                    });
                }

                async triggerComposeAi(windowId, command) {
                    const composeWindow = this.composeWindows.find(w => w.id === windowId);
                    if (!composeWindow) {
                        console.warn('Compose window not found:', windowId);
                        return;
                    }
                    const windowElement = composeWindow.element;
                    const textarea = windowElement.querySelector('.compose-message');
                    const subjectInput = windowElement.querySelector('.compose-subject');
                    if (!textarea) {
                        return;
                    }

                    const currentDraft = textarea.value.trim();
                    const currentSubject = subjectInput ? subjectInput.value.trim() : '';
                    const instruction = this.buildComposeInstruction(command, currentDraft, composeWindow.isReply);
                    this.setComposeButtonsDisabled(windowElement, true);

                    try {
                        const data = await this.callAiCommand(command, instruction, {
                            contextId: this.selectedEmail?.contextId,
                            subject: currentSubject
                        });
                        const text = this.extractPlainTextFromResponse(data);
                        if (text) {
                            const parsed = this.parseSubjectAndBody(text);
                            if (subjectInput && parsed.subject) {
                                subjectInput.value = parsed.subject;
                            }
                            textarea.value = parsed.body;
                        }
                    } catch (error) {
                        alert(`AI ${command} failed: ${error?.message || 'Unknown error'}`);
                    } finally {
                        this.setComposeButtonsDisabled(windowElement, false);
                    }
                }

                buildInstructionForCommand(command) {
                    return this.commandDefaults[command] || 'Assist with the selected email.';
                }

                buildComposeInstruction(command, currentDraft, isReply) {
                    if (command === 'tone') {
                        if (currentDraft.length > 0) {
                            return `Friendly and professional tone.

Current draft:
${currentDraft}`;
                        }
                        return 'Adjust the tone to be friendly yet professional.';
                    }

                    if (currentDraft.length > 0) {
                        return currentDraft;
                    }

                    if (command === 'draft') {
                        return isReply
                            ? 'Draft a thoughtful reply acknowledging the email and outlining next steps.'
                            : 'Draft a concise email that introduces the topic and requests next steps.';
                    }

                    if (command === 'compose') {
                        return 'Compose a polished email based on the current conversation context.';
                    }

                    return this.commandDefaults[command] || 'Assist with the email draft.';
                }

                getTitleForCommand(command) {
                    return this.commandTitles[command] || 'AI Assistant';
                }

                setMainCommandButtonsDisabled(disabled) {
                    if (!this.emailContent) return;
                    this.emailContent.querySelectorAll('.ai-command-btn').forEach(btn => {
                        btn.disabled = disabled;
                        btn.setAttribute('aria-busy', String(disabled));
                        btn.style.opacity = disabled ? '0.6' : '1';
                    });
                }

                setComposeButtonsDisabled(windowElement, disabled) {
                    windowElement.querySelectorAll('.ai-command-btn').forEach(btn => {
                        btn.disabled = disabled;
                        btn.setAttribute('aria-busy', String(disabled));
                        btn.style.opacity = disabled ? '0.6' : '1';
                    });
                }

                clearAiResponse() {
                    if (!this.aiResponsePanel) {
                        return;
                    }
                    this.aiResponsePanel.style.display = 'none';
                    const titleEl = this.aiResponsePanel.querySelector('[data-role="ai-response-title"]');
                    const bodyEl = this.aiResponsePanel.querySelector('[data-role="ai-response-body"]');
                    if (titleEl) {
                        titleEl.textContent = 'AI Assistant';
                    }
                    if (bodyEl) {
                        bodyEl.innerHTML = '';
                    }
                }

                setAiResponseState({ status, title, html, message }) {
                    if (!this.aiResponsePanel) {
                        this.aiResponsePanel = document.getElementById('aiResponsePanel');
                    }
                    if (!this.aiResponsePanel) {
                        return;
                    }
                    this.aiResponsePanel.style.display = 'block';
                    const titleEl = this.aiResponsePanel.querySelector('[data-role="ai-response-title"]');
                    const bodyEl = this.aiResponsePanel.querySelector('[data-role="ai-response-body"]');
                    if (titleEl) {
                        titleEl.textContent = title || 'AI Assistant';
                    }
                    if (bodyEl) {
                        if (status === 'loading') {
                            bodyEl.innerHTML = '<div class="text-sm text-slate-500">Thinking...</div>';
                        } else if (status === 'error') {
                            bodyEl.innerHTML = `<div class="text-sm text-rose-600">${window.ComposerAI.escapeHtml(message || 'Something went wrong.')}</div>`;
                        } else {
                            bodyEl.innerHTML = html || '<div class="text-sm text-slate-500">No response received.</div>';
                        }
                    }
                }

                async callAiCommand(command, instruction, { contextId, subject } = {}) {
                    const payload = {
                        message: instruction && instruction.trim().length > 0 ? instruction.trim() : (this.commandDefaults[command] || 'Assist with the selected email.'),
                        conversationId: this.conversationId,
                        maxResults: this.defaultMaxResults,
                        thinkingEnabled: false,
                        jsonOutput: false
                    };

                    const activeEmail = this.selectedEmail;
                    const derivedContextId = contextId || (activeEmail && activeEmail.contextId);
                    if (derivedContextId) {
                        payload.contextId = derivedContextId;
                    }
                    if (activeEmail) {
                        const contextString = buildEmailContextString(activeEmail);
                        if (contextString && contextString.trim().length > 0) {
                            payload.emailContext = contextString;
                        }
                    }

                    if (this.supportedCommands.has(command)) {
                        payload.aiCommand = command;
                    }

                    if (subject && subject.trim().length > 0) {
                        payload.subject = subject.trim();
                    }

                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-UI-Request': UI_NONCE
                        },
                        body: JSON.stringify(payload)
                    });

                    let data;
                    try {
                        data = await response.json();
                    } catch (error) {
                        data = null;
                    }

                    if (!response.ok) {
                        const errorMessage = data?.message || data?.error || `Request failed with status ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    if (data?.conversationId) {
                        this.conversationId = data.conversationId;
                    }

                    return data;
                }

                extractHtmlFromResponse(data) {
                    if (!data) {
                        return '<div class="text-sm text-slate-500">No response received.</div>';
                    }
                    if (data.sanitizedHtml && data.sanitizedHtml.trim().length > 0) {
                        return data.sanitizedHtml;
                    }
                    if (data.response && data.response.trim().length > 0) {
                        return window.ComposerAI.renderMarkdown(data.response);
                    }
                    return '<div class="text-sm text-slate-500">No response received.</div>';
                }

                parseSubjectAndBody(text) {
                    if (!text || text.trim().length === 0) {
                        return { subject: '', body: '' };
                    }

                    const trimmed = text.trim();
                    const subjectMatch = trimmed.match(/^Subject:\s*(.+?)$/m);

                    if (subjectMatch) {
                        const subject = subjectMatch[1].trim();
                        const subjectEndIndex = trimmed.indexOf(subjectMatch[0]) + subjectMatch[0].length;
                        const body = trimmed.substring(subjectEndIndex).replace(/^\s*\n+/, '').trim();
                        return { subject, body };
                    }

                    return { subject: '', body: trimmed };
                }

                extractPlainTextFromResponse(data) {
                    if (!data) {
                        return '';
                    }
                    if (data.response && data.response.trim().length > 0) {
                        return data.response.trim();
                    }
                    if (data.sanitizedHtml && data.sanitizedHtml.trim().length > 0) {
                        const temp = document.createElement('div');
                        temp.innerHTML = data.sanitizedHtml;
                        return temp.textContent.trim();
                    }
                    return '';
                }

            }

            function handleAICommand(command) {
                if (window.emailClient instanceof EmailClient) {
                    window.emailClient.triggerAiCommand(command);
                }
            }

            function handleComposeAI(windowId, command) {
                if (window.emailClient instanceof EmailClient) {
                    window.emailClient.triggerComposeAi(windowId, command);
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                window.emailClient = new EmailClient();
            });
        </script>
        <!-- Load email renderer module after DOM is ready -->
        <script src="/js/email-renderer.js"></script>
    </div>
</body>

</html>
